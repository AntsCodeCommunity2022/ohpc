#!./common/bats/bin/bats

export BATS_JUNIT_CLASS=Singularity
source ./common/TEST_ENV  || exit 1
load ./common/test_helper_functions || exit 1
source ./common/functions || exit 1

echo " "
echo " "
echo "-------------------------------------------------------"
echo "Runtimes: Singularity"
echo "-------------------------------------------------------"

if [ "x$DISTRO_FAMILY" == "xCentOS" ];then
    export DISTRO=centos
else
    export DISTRO=sles
fi
export BOOTSTRAP_DEF=/opt/ohpc/pub/doc/contrib/singularity-ohpc/examples/${DISTRO}.def

@test "[singularity] check for RPM" {
    check_if_rpm_installed "singularity${DELIM}"
}

@test "[singularity] create image" {
    singularity create /tmp/${DISTRO}.img
    assert_success
}

@test "[singularity] bootstrap image" {
    singularity bootstrap /tmp/${DISTRO}.img ${BOOTSTRAP_DEF}
    assert_success
}

@test "[singularity] exec image" {
    singularity exec /tmp/${DISTRO}.img cat /etc/os-release
    assert_success
    rm -rf /tmp/${DISTRO}.img
}
