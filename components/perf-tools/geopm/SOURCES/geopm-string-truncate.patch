From c6d16e060114d2d5136036bd20d179f2626e5ce7 Mon Sep 17 00:00:00 2001
From: "Christopher M. Cantalupo" <christopher.m.cantalupo@intel.com>
Date: Thu, 28 Jun 2018 09:00:11 -0700
Subject: [PATCH] Fix possible C string truncation caught by gcc 8.

Change-Id: I438b82c94e77198721e70f335e1d12b322f24af6
Signed-off-by: Christopher M. Cantalupo <christopher.m.cantalupo@intel.com>
---
 src/Exception.cpp      |  4 ++--
 src/geopmpolicy_main.c | 18 +++++++++---------
 2 files changed, 11 insertions(+), 11 deletions(-)

diff --git a/src/Exception.cpp b/src/Exception.cpp
index e6a152268..3630bcccf 100644
--- a/src/Exception.cpp
+++ b/src/Exception.cpp
@@ -144,7 +144,7 @@ extern "C"
     void geopm_error_destroy_shmem(void)
     {
         int err = 0;
-        char err_msg[NAME_MAX];
+        char err_msg[2 * NAME_MAX];
         DIR *did = opendir("/dev/shm");
         if (did &&
             strlen(geopm_env_shmkey()) &&
@@ -161,7 +161,7 @@ extern "C"
                     strncpy(shm_key + 1, entry->d_name, NAME_MAX - 2);
                     err = shm_unlink(shm_key);
                     if (err) {
-                        snprintf(err_msg, NAME_MAX, "Warning: <geopm> unable to unlink \"%s\"", shm_key);
+                        snprintf(err_msg, 2 * NAME_MAX, "Warning: <geopm> unable to unlink \"%s\"", shm_key);
                         perror(err_msg);
                     }
                 }
diff --git a/src/geopmpolicy_main.c b/src/geopmpolicy_main.c
index 2acc643fe..30bca89bc 100644
--- a/src/geopmpolicy_main.c
+++ b/src/geopmpolicy_main.c
@@ -73,7 +73,7 @@ int main(int argc, char** argv)
     char file[GEOPMPOLICY_STRING_LENGTH] = {0};
     char mode_string[GEOPMPOLICY_STRING_LENGTH] = {0};
     char option_string[GEOPMPOLICY_STRING_LENGTH] = {0};
-    char copy_string[GEOPMPOLICY_STRING_LENGTH] = {0};
+    char copy_string[2 * GEOPMPOLICY_STRING_LENGTH] = {0};
     char error_string[GEOPMPOLICY_STRING_LENGTH] = {0};
     FILE *infile = NULL;
     FILE *outfile = NULL;
@@ -242,12 +242,12 @@ int main(int argc, char** argv)
                 }
                 if (!err) {
                     if (file[0] == '/') {
-                        snprintf(copy_string, GEOPMPOLICY_STRING_LENGTH, "/tmp%s", file);
-                        strncpy(file, copy_string, GEOPMPOLICY_STRING_LENGTH);
+                        snprintf(copy_string, 2 * GEOPMPOLICY_STRING_LENGTH, "/tmp%s", file);
+                        strncpy(file, copy_string, 2 * GEOPMPOLICY_STRING_LENGTH);
                     }
                     else {
-                        snprintf(copy_string, GEOPMPOLICY_STRING_LENGTH, "/tmp/%s", file);
-                        strncpy(file, copy_string, GEOPMPOLICY_STRING_LENGTH);
+                        snprintf(copy_string, 2 * GEOPMPOLICY_STRING_LENGTH, "/tmp/%s", file);
+                        strncpy(file, copy_string, 2 * GEOPMPOLICY_STRING_LENGTH);
                     }
                 }
             }
@@ -292,13 +292,13 @@ int main(int argc, char** argv)
                 }
                 if (!err) {
                     if (file[0] == '/') {
-                        snprintf(copy_string, GEOPMPOLICY_STRING_LENGTH, "/tmp%s", file);
-                        strncpy(file, copy_string, GEOPMPOLICY_STRING_LENGTH);
+                        snprintf(copy_string, 2 * GEOPMPOLICY_STRING_LENGTH, "/tmp%s", file);
+                        strncpy(file, copy_string, 2 * GEOPMPOLICY_STRING_LENGTH);
                     }
                     else {
                         printf("file = %s\n",file);
-                        snprintf(copy_string, GEOPMPOLICY_STRING_LENGTH, "/tmp/%s", file);
-                        strncpy(file, copy_string, GEOPMPOLICY_STRING_LENGTH);
+                        snprintf(copy_string, 2 * GEOPMPOLICY_STRING_LENGTH, "/tmp/%s", file);
+                        strncpy(file, copy_string, 2 * GEOPMPOLICY_STRING_LENGTH);
                         printf("file = %s\n",file);
                     }
                 }
